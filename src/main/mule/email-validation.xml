<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:validation="http://www.mulesoft.org/schema/mule/validation"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<validation:config name="Validation_Config" doc:name="Validation Config" doc:id="cc54d9b3-c5dd-4317-a998-6b90e4a313a7" />
	<sub-flow name="email-validationSub_Flow" doc:id="64a09956-2949-4b34-b73c-823ef264ccec" >
		<validation:is-email doc:id="c401d87c-fc42-46ac-8b77-b64191f64708" config-ref="Validation_Config" email="#[payload.emailReceived]" message="Invalid email address, please corret it"/>
		<ee:transform doc:name="Transform Message" doc:id="bbf01043-53cc-47a8-9e73-822f4fbb83a1" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"email": payload.emailReceived default "",
	"name" : payload.name default ""
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="62f2dbbb-b4a3-4b11-a1aa-350441817ec4" message="#[payload]"/>
	</sub-flow>
	<sub-flow name="dataWeave-validationFlow" doc:id="a7746758-37db-42ef-80ab-6ba420725c33" >
		<set-payload value='#[[&#10;  {&#10;    "first_name": "James",&#10;    "zip": 70.116&#10;  },&#10;  {&#10;    "first_name": "Josephine",&#10;    "zip": 48.816&#10;  },&#10;  {&#10;    "first_name": "Art",&#10;    "zip": 80.142&#10;  },&#10;  {&#10;    "first_name": "Lenna",&#10;    "zip": 9.9501&#10;  }&#10;]]' doc:name="Set Payload" doc:id="b890772a-6b47-4b0a-bbfd-bd7a5715124f" />
		<ee:transform doc:name="Transform Message" doc:id="3be02271-0f2c-4fdd-b9d4-1f91d1d10641" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
// function to scan the decimal value from a number 
fun decimal(data) = flatten (data scan(".?[0-9]+"))[1]
var det = payload map (item, index) ->  {
    "Quantity": decimal(item.zip)
}
// var decending: to order decimal values in decending order
var decending = (det orderBy (ten)-> ten.Quantity)[-1 to 0] 

// var add : to sum the decimal value and round the value
var add= round(sum((decending).Quantity))

// var payloadAfterDecending = To order the payload in decending order based on decimal value  
var payloadAfterDecending = decending flatMap (v) ->
    payload filter ($.zip contains (v.Quantity))
---
// using decimal sum(var add) add 1 to zip in each object in the sorted payload(var payloadAfterDecending) using index < decimal sum(var add)
payloadAfterDecending map (value,index)-> {
    "first_name" : value.first_name,
    "QT" : if (index < add) round(value.zip) +1 else round(value.zip)
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="53e6d1cb-5b01-4f36-8513-c7e91b714f33" message='"client_secret" : #[attributes.headers.client_secret], 	"client_id" : #[attributes.headers.client_id]'/>
	</sub-flow>
</mule>
